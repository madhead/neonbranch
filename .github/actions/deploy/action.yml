name: Deploy
description: Deploy the lambda

inputs:
  environment:
    required: false
    description: The environment to deploy to
  role:
    required: true
    description: IAM role to assume for deployment
  region:
    required: true
    description: AWS region to deploy to

outputs:
  URL:
    value: ${{ steps.URL.outputs.URL }}
    description: The URL of the environment

runs:
  using: composite
  steps:
    - uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: ${{ inputs.role }}
        aws-region: ${{ inputs.region }}

    - uses: actions/setup-python@v4
      with:
        python-version: 3.9

    - run: python -m venv .venv
      working-directory: deploy
      shell: bash

    - run: |
        source .venv/bin/activate
        python -m pip install -r requirements.txt
      working-directory: deploy
      shell: bash

    - run: |
        source .venv/bin/activate
        npx cdk deploy --context environment=${{ inputs.environment }} --outputs-file=cdk.out/outputs.json --require-approval=never
      working-directory: deploy
      shell: bash

    - id: URL
      run: echo "URL=$(jq -r 'keys[] as $stack | .[$stack].URL' cdk.out/outputs.json)" >> $GITHUB_OUTPUT
      working-directory: deploy
      shell: bash
